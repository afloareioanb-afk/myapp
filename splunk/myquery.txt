index="app_events_dk1332-k*" structured.x-request-id="MMDEOPRA*" structured.message!="Record not found for id*" structured.x-request-id!="MM*99999999*"
| eval s_level = lower('structured.level'), l_level =lower('level')
| eval is_error = if((s_level="info" and l_level="info") or (s_level="warn" and l_level="warn") or (s_level="info" and l_level="error") or (s_level="debug" and l_level="debug"), 0, 1)
| eval is_completed = if(like('structured.message', "Client feedback service response: accepted 1, rejected 0, StatusCode: 200"), 1, 0)
| eval is_scn_log = if(like('structured.message', "received response from ccmiles - customer info"), 1, 0)
| stats
max(is_error) as had_error
max(is_completed) as had_completed
max(is_scn_log) as has_scn_log
max(structured.SCN) as user_scn
by structured.x-request-id
| where has_scn_log=1 AND user_scn!=""
| eval req_with_error = if(had_error=1, 1, 0)
| eval req_completed = if(had_completed=1, 1, 0)
| eval req_started_but_not_completed = if(had_completed=0, 1, 0)
| eval req_started_but_not_completed_with_errors = if(had_error=1 AND had_completed=0, 1, 0)
| eval req_completed_with_errors = if(had_error=1 AND had_completed=1, 1, 0)
| stats
count as total_transactions
sum(req_started_but_not_completed) as transactions_started_not_completed
sum(req_completed) as transactions_completed
sum(req_completed_with_errors) as transactions_completed_with_errors
sum(req_with_error) as transactions_with_error
sum(req_started_but_not_completed_with_errors) as transactions_started_with_errors
by user_scn
| eval scn_has_completed_transaction = if(transactions_completed > 0, 1, 0)
| stats
count as total_scns
sum(scn_has_completed_transaction) as scns_with_completed_transactions
| eval absolute_completion_rate = round ((scns_with_completed_transactions/total_scns) * 100, 2)
| fields absolute_completion_rate, total_scns, scns_with_completed_transactions